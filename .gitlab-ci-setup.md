# GitLab CI/CD Setup for AMSA Backend

## Required GitLab CI/CD Variables

To enable automated deployments, you need to configure these variables in your GitLab repository:

**Settings → CI/CD → Variables**

| Variable Name | Description | Example Value | Protected | Masked |
|--------------|-------------|---------------|-----------|--------|
| `SSH_PRIVATE_KEY` | Private SSH key for VM access | `-----BEGIN OPENSSH PRIVATE KEY-----...` | ✓ | ✓ |
| `VM_USER` | SSH username for VM | `root` | ✓ | - |
| `VM_HOST` | VM server hostname/IP | `backend.amsa.mn` or IP address | ✓ | - |
| `DEPLOY_PATH` | Backend directory path on VM | `/root/amsa/amsa-backend` | - | - |

## How It Works

1. **Trigger**: Pipeline runs automatically when you push to `master` branch
2. **SSH Connection**: GitLab runner connects to your VM using the SSH key
3. **Code Update**: Pulls latest code from `origin/master`
4. **Dependencies**: Runs `npm ci` to install/update packages
5. **Restart**: Restarts the backend using PM2

## Manual Deployment

If you need to manually trigger the pipeline:
1. Go to CI/CD → Pipelines
2. Click "Run pipeline"
3. Select `master` branch
4. Click "Run pipeline"

## Troubleshooting

### Pipeline fails at SSH connection
- Verify `SSH_PRIVATE_KEY` is correct and matches the public key on your VM
- Check that `VM_USER` and `VM_HOST` are correct
- Ensure VM firewall allows SSH connections from GitLab runners

### Pipeline fails at git operations
- Verify the SSH key on your VM has access to the GitLab repository
- Check that `DEPLOY_PATH` points to the correct directory

### PM2 restart fails
- Verify PM2 process name matches `"AMSA Bac"` (run `pm2 list` on VM)
- Check that the backend starts without errors after `npm ci`

## Testing the Pipeline

After setting up the variables:
1. Make a small change to any file (e.g., add a comment)
2. Commit and push to `master` branch
3. Check GitLab CI/CD → Pipelines to see the deployment progress
4. Verify the backend is running on your VM with `pm2 list`

